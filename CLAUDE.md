# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Todo web application built with Go, featuring user authentication and HTMX for dynamic updates.

**Tech Stack:**
- **Web Framework:** Echo v4
- **ORM:** bob (database-first, generates type-safe models from schema)
- **Templates:** Templ (type-safe HTML templates)
- **Database:** SQLite (modernc.org/sqlite - pure Go driver)
- **Session:** scs with sqlite3store
- **Auth:** bcrypt + scs (simple implementation, no auth framework)
- **Frontend Assets:** Vite (olivere/vite for Go integration)
- **CSS:** Pico CSS (via npm)
- **JS:** HTMX (via npm)

## Common Commands

```bash
# Development (hot reload with air)
go tool air

# Generate Templ templates
go tool templ generate

# Database migrations
go tool goose -dir db/migrations sqlite3 db/app.db up
go tool goose -dir db/migrations sqlite3 db/app.db down
go tool goose -dir db/migrations create <name> sql

# Generate bob models from database schema
go tool bobgen-sqlite

# Build
go build .

# Frontend (Vite)
cd frontend && pnpm install   # Install dependencies
cd frontend && pnpm run dev   # Start Vite dev server
cd frontend && pnpm run build # Build for production

# Development workflow (2 terminals)
# Terminal 1: cd frontend && pnpm run dev
# Terminal 2: VITE_DEV=true go tool air
```

## Architecture

### Directory Structure
- `main.go` - Application entry point, routes, middleware, handlers
- `views/` - Templ templates (`.templ` files generate `_templ.go`)
- `models/` - bob-generated database models (DO NOT EDIT, regenerated by bobgen-sqlite)
- `db/migrations/` - goose SQL migrations
- `factory/`, `dbinfo/`, `dberrors/` - bob-generated helpers (DO NOT EDIT)
- `frontend/` - Vite project (CSS/JS assets)
  - `src/main.js` - Entry point (imports Pico CSS + HTMX)
  - `dist/` - Build output (embedded in Go binary via go:embed)

### Key Patterns

**Database-first ORM:** Schema changes flow as: SQL migration → goose up → bobgen-sqlite → type-safe models

**Authentication:** Simple session-based auth using scs + bcrypt. Session stored in SQLite `sessions` table. User ID stored in session as `user_id`.

**HTMX Integration:** Partial HTML responses for dynamic updates. Templates return full page or partial based on endpoint design.

**Middleware Order (in main.go):**
1. RequestLogger
2. Recover
3. scs.LoadAndSave (session)
4. CSRF
5. Vite scripts injection (adds Vite tags to context)

**Vite Integration:** Uses `olivere/vite` library. In development mode (`VITE_DEV=true`), assets are served from Vite dev server (localhost:5173). In production, assets are embedded in the binary via `go:embed` and served from `/assets/`.

### bob Query Examples
```go
// Select with where
models.Users.Query(models.SelectWhere.Users.Email.EQ(email)).One(ctx, db)

// Insert
models.Users.Insert(&models.UserSetter{Email: omit.From(email)}).One(ctx, db)

// Update
user.Update(ctx, db, &models.UserSetter{UpdatedAt: omit.From(time.Now())})
```

## Configuration Files
- `.air.toml` - Hot reload config (runs `templ generate` before build)
- `bobgen.yaml` - bob code generation config
